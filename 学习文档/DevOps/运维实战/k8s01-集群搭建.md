# k8s搭建

1. kubeamd方式
2. 问题处理
   - [kubeadm证书/etcd证书过期](#kubeadm证书/etcd证书过期)



## kubeamd方式

### 一. 初始化操作

1、首先关闭服务器的防火墙

```bash
systemctl stop firewalld     # 永久关闭
systemctl disable firewalld  # 永久关闭

# 永久关闭selinux
sed -i 's/enforcing/disabled/' /etc/selinux/config
# 关闭swap分区
swapoff -a                            # 临时
sed  -ri 's/.*swap.*/#&/' /etc/fstab  # 永久关闭
```

2、给主机添加主机名称方便管理

```bash
Hostnamectl angel1
Hostnamectl angel2
Hostnamectl angel3
Hostnamectl angel4
# 在master服务器添加hosts，其他不用添加
# /etc/hosts配置文件中加入你的ip及修改的名字
vim /etc/hosts
# --------------------------------------
192.168.137.151 angel1
192.168.137.152 angel2
192.168.137.153 angel3
192.168.137.154 angel4
# --------------------------------------
```

3、将桥接的IPV4流量传递到iptanles的链

```bash
# /etc/sysctl.d/k8s.conf 服务器的配置文件加入下面两行。
vim /etc/sysctl.d/k8s.conf
# ---------------------------------------
net.bridge.bridge-nf-call-ip6tables=1
net.bridge.bridge-nf-call-iptables=1
# --------------------------------------

# 执行如下立即生效
sysctl --system
```

4、服务器同步时间

```bash
yum -y install ntpdate -y
ntpdate time.windows.com
```

### 二、所有节点的准备工作

1、所有节点安装docker

```bash
wget -i http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
cp docker-ce.repo /etc/yum.repos.d/

# 安装所需软件包
yum install -y yum-utils device-mapper-persistent-data lvm2

# 查看各版本docker
yum list docker-ce --showduplicates | sort -r
# 安装dockers
yum install -y docker-ce-18.06.1.ce-3.el7
# 启动dockers
systemctl start docker
systemctl enable docker.service
```

2、Docker中的仓库配置（所有节点）

```bash
cat >/etc/docker/daemon.json << EOF
{
  "registry-mirrors":["https://b9pmyelo.mirror.aliyuncs.com"]
}
EOF

# 配置完成需要重启docker
systemctl restart docker
```

3、添加阿里云yum软件源（所有节点执行）

```bash
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
```

4、部署kubeadm,kubelet和kubectl（所有节点执行）

```bash
# 由于版本更新频繁，这里指定版本号部署
yum clean all
rpm --rebuilddb
yum -y makecache
yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0

# 检查是否安装
rpm -qa | grep kubelet
rpm -qa | grep kubeadm
rpm -qa | grep kubectl
rpm -qa | grep kubernetes-cni

# 启动kubelet，并设置开机启动
systemctl enable kubelet && systemctl start kubelet
```

5、初始化master（在master上面执行）

```bash
# apiserver-advertise-address指定master的ip地址
# pod-network-cidr指定Pod网络的范围，这里使用flannel网络方案
kubeadm init --kubernetes-version=1.18.0 --apiserver-advertise-address=192.168.137.151 --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.1.0.0/24 --pod-network-cidr=10.244.0.0/24
```

6、加入kubernetes node

```bash
# 初始化完成后后有两部分需要在master与node上面分别执行，根据提示执行即可
# master执行
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
# node执行
kubeadm join 192.168.137.151:6443 --token 19tdgr.724p9jtnvirj4p1e \
    --discovery-token-ca-cert-hash sha256:004273965bf1cd66cfc4ea2cdb992e5e520426d3a07a13618841728ff4de8b55
# 在master节点执行，查看是否有节点加入
kubectl get nodes
```

错误处理：[kubeadm证书/etcd证书过期](#kubeadm证书/etcd证书过期)

7、部署CNI网络插件（在master执行）

```bash
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
# 如果该网址被墙，请看附录问题解决方案
# 查看是否执行完成已经运行
kubectl get pods -n kube-system
# 查看详情
kubectl describe pod -n kube-system kube-flannel-ds-amd64-gc5fm
# 查看日志
kubectl logs kube-flannel-ds-amd64-gc5fm -n kube-system
# 删除错误pod
kubectl delete pod -n kube-system kube-flannel-ds-amd64-tsr67
```

![x](../../../Resources/k8s001.png)

上面的状态全部为1/1时，使用`kubectl get nodes`，查看是否是已经就绪

![x](../../../Resources/k8s002.png)

集群已经搭建完成。

8、测试kubernetes集群

在kubernetes集群中创建一个pod，验证是否正常运行。

```bash
kubectl create deployment nginx --image=nginx  # 拉取一个nginx
kubectl get pod  # 查看是否拉取完成。Running已经拉取完成

# 当状态是running时执行对外进行端口暴露。
kubectl expose deployment nginx --port=80 --type=NodePort

kubectl get pod,svc  # 查看对外的端口
```

![x](../../../Resources/k8s003.png)

测试：master的ip加上31667可以访问，node节点的ip加上31667也可以访问。

k8s集群搭建完成。



### 问题处理

#### kube-flannel.yml被墙

自己创建 [kube-flannel.yml](../../../Resources/kube-flannel.yml)

执行：

```sh
kubectl apply -f kube-flannel.yml 
```

#### kubeadm证书/etcd证书过期

错误：

```sh
Unable to connect to the server: x509: certificate has expired or is not yet valid
```







参考：

- https://blog.csdn.net/ahilll/article/details/81979947
- https://blog.csdn.net/ywq935/category_7572923_2.html